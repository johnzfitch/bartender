#!/bin/bash
# Bartender wrapper script - runs headless by default

# Resolve symlink to get actual script location
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [[ -L "$SCRIPT_PATH" ]]; do
    SCRIPT_DIR="$(cd -P "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    [[ "$SCRIPT_PATH" != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
SCRIPT_DIR="$(cd -P "$(dirname "$SCRIPT_PATH")" && pwd)"

BARTENDER_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
cd "$BARTENDER_DIR" || exit 1

show_help() {
    cat << EOF
Bartender - GTK4 Status Bar

Usage: bartender [OPTIONS]

Options:
    (no args)      Run bartender in background (headless)
    --log          Run in foreground, show all output
    --debug        Run in foreground with debug logging enabled
    --stop         Stop running bartender instance
    --restart      Restart bartender
    --status       Show bartender status
    --help, -h     Show this help message

Examples:
    bartender              # Start in background
    bartender --log        # Start with live logs
    bartender --debug      # Start with debug logs
    bartender --stop       # Stop bartender

Log files:
    ~/.local/state/bartender/feed-debug-*.log  (if debug_log enabled in config)
EOF
}

check_running() {
    # Check for gjs process running from bartender directory
    local pid
    pid=$(pgrep -f "gjs -m.*ags.js" | while read p; do
        local cwd
        cwd=$(readlink -f "/proc/$p/cwd" 2>/dev/null)
        if [[ "$cwd" == "$BARTENDER_DIR" ]]; then
            echo "$p"
            break
        fi
    done)
    [[ -n "$pid" ]]
}

stop_bartender() {
    echo "Stopping bartender..."
    # Find and kill bartender gjs processes
    pgrep -f "gjs -m.*ags.js" | while read pid; do
        local cwd
        cwd=$(readlink -f "/proc/$pid/cwd" 2>/dev/null)
        if [[ "$cwd" == "$BARTENDER_DIR" ]]; then
            kill "$pid" 2>/dev/null
        fi
    done

    sleep 1
    if check_running; then
        # Force kill if still running
        pgrep -f "gjs -m.*ags.js" | while read pid; do
            local cwd
            cwd=$(readlink -f "/proc/$pid/cwd" 2>/dev/null)
            if [[ "$cwd" == "$BARTENDER_DIR" ]]; then
                kill -9 "$pid" 2>/dev/null
            fi
        done
        echo "Forcefully stopped bartender"
    else
        echo "Bartender stopped"
    fi
}

show_status() {
    if check_running; then
        echo "Bartender is running"
        # Find and show bartender gjs process
        pgrep -f "gjs -m.*ags.js" | while read pid; do
            local cwd
            cwd=$(readlink -f "/proc/$pid/cwd" 2>/dev/null)
            if [[ "$cwd" == "$BARTENDER_DIR" ]]; then
                echo "  PID: $pid"
                echo "  Working directory: $cwd"
            fi
        done

        # Show article count if cache exists
        local cache="$HOME/.local/state/bartender/article-cache.json"
        if [[ -f "$cache" ]]; then
            local count=$(jq -r '.articles | length' "$cache" 2>/dev/null)
            [[ -n "$count" ]] && echo "  Articles in cache: $count"
        fi
    else
        echo "Bartender is not running"
        return 1
    fi
}

# Parse arguments
case "${1:-}" in
    --help|-h)
        show_help
        exit 0
        ;;
    --stop)
        stop_bartender
        exit 0
        ;;
    --status)
        show_status
        exit $?
        ;;
    --restart)
        if check_running; then
            stop_bartender
        fi
        echo "Starting bartender in background..."
        nohup ags run . >/dev/null 2>&1 &
        disown
        sleep 2
        if check_running; then
            show_status
        else
            echo "Failed to start bartender"
            exit 1
        fi
        exit 0
        ;;
    --log)
        echo "Starting bartender with live logs (Ctrl+C to stop)..."
        if check_running; then
            echo "Warning: Bartender is already running. Stopping existing instance..."
            stop_bartender
        fi
        exec ags run .
        ;;
    --debug)
        echo "Starting bartender with debug logging (Ctrl+C to stop)..."
        if check_running; then
            echo "Warning: Bartender is already running. Stopping existing instance..."
            stop_bartender
        fi
        # Enable debug logging in environment
        export BARTENDER_DEBUG=1
        exec ags run .
        ;;
    "")
        # No arguments - run in background (headless mode)
        if check_running; then
            echo "Bartender is already running"
            show_status
            exit 0
        fi

        echo "Starting bartender in background..."
        nohup ags run . >/dev/null 2>&1 &
        disown
        sleep 2

        if check_running; then
            show_status
            echo
            echo "  Use 'bartender --log' to see live output"
            echo "  Use 'bartender --stop' to stop"
            echo "  Use 'bartender --status' to check status"
        else
            echo "Failed to start bartender"
            echo "  Try 'bartender --log' to see error output"
            exit 1
        fi
        ;;
    *)
        echo "Unknown option: $1"
        echo "Use 'bartender --help' for usage information"
        exit 1
        ;;
esac
